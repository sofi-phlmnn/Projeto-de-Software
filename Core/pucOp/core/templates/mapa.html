{% extends "base.html" %}
{% load static %}

{% block title %}PUC Oportunidades — Mapa{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/mapa.css' %}">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="{% static 'css/mapa-leaflet.css' %}">
{% endblock %}

{% block content %}
<div class="site-root">
  <section class="hero">
    <div class="map-container">
      <div class="hero-card">
        <div class="hero-card__ornament" aria-hidden="true"></div>
        <div class="hero-card__sealwrap">
          <img class="hero-card__seal" src="{{ hero.logo_url }}" alt="Brasão da PUC-Rio" />
        </div>
        <div class="hero-card__text">
          <h2 class="hero-card__title">{{ hero.titulo }}</h2>
          <p class="hero-card__desc">{{ hero.descricao }}</p>
        </div>
      </div>
    </div>
  </section>

  <main class="conteudo-principal">
    <div class="map-container">
      <div class="colunas">
        <section class="coluna-esquerda">
          <div class="cartao cartao--espacado">
            <h2 class="titulo-cartao">Mapa PUC-Rio</h2>
          </div>
          <div class="cartao cartao--crescer cartao--mapa">
            <div id="map" class="mapa-interativo" aria-label="Mapa PUC-Rio"></div>
            <noscript>
              <a href="{{ mapa.link }}" target="_blank" rel="noopener noreferrer" title="Abrir no Google Maps">
                Ver no Google Maps
              </a>
            </noscript>
          </div>
        </section>

        <aside class="coluna-direita">
          {% for p in paines %}
          <div class="cartao">
            <div class="cabecalho-cartao">
              <span class="indicador indicador--{{ p.color }}" aria-hidden="true"></span>
              <h3 class="titulo-cartao">{{ p.title }}</h3>
            </div>
            <ul class="lista-informacoes">
              {% for item in p.itens %}
                <li data-ponto="{{ item }}">
                  <span class="indice">{{ forloop.counter }}.</span> {{ item }}
                </li>
              {% endfor %}
            </ul>
          </div>
          {% endfor %}
        </aside>
      </div>
    </div>
  </main>
</div>

{% if pontos %}{{ pontos|json_script:"pontos-data" }}{% endif %}
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
(function () {
  // Lê pontos do JSON gerado pelo Django
  let pontos = [];
  try {
    const el = document.getElementById('pontos-data');
    if (el) {
      pontos = JSON.parse(el.textContent) || [];
    }
  } catch (e) {
    console.error('Erro ao ler pontos do mapa:', e);
  }

  const COORDS_PADRAO = [-22.9796, -43.2335];

  // centro inicial = primeiro ponto válido, senão padrão
  let initialCoords = COORDS_PADRAO;
  if (Array.isArray(pontos) && pontos.length) {
    const base = pontos.find(p => typeof p.lat === 'number' && typeof p.lng === 'number');
    if (base) {
      initialCoords = [base.lat, base.lng];
    }
  }

  const INITIAL_ZOOM = 17;

  // Limites do campus
  const CAMPUS_BOUNDS = L.latLngBounds(
    [-22.98100, -43.23580], // sudoeste
    [-22.97820, -43.23180]  // nordeste
  );

  const map = L.map('map', {
    zoomControl: true,
    scrollWheelZoom: true,
    dragging: true,
    tap: true,
    maxBounds: CAMPUS_BOUNDS,
    maxBoundsViscosity: 1.0,
    minZoom: 17,
    maxZoom: 18
  }).setView(initialCoords, INITIAL_ZOOM);



  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap colaboradores'
  }).addTo(map);

  const bounds = [];
  const markersByName = {};
  const colorByTipo = {
    campus:      '#6A0DAD',
    equipes:     '#f97316',
    inovacao:    '#10b981',
    estagio:     '#ec4899',
    alimentacao: '#2563eb',
    secretaria:  '#22c55e'
  };

  // cria markers
  if (Array.isArray(pontos)) {
    pontos.forEach(p => {
      if (typeof p.lat === 'number' && typeof p.lng === 'number') {
        const coord = [p.lat, p.lng];
        const cor = colorByTipo[p.tipo] || '#6A0DAD';

        let marker;
        if (p.tipo) {
          marker = L.circleMarker(coord, {
            radius: 8,
            color: cor,
            fillColor: cor,
            fillOpacity: 0.9
          }).addTo(map);
        } else {
          marker = L.marker(coord).addTo(map);
        }

        const titulo = p.name ? `<b>${p.name}</b>` : '<b>Ponto</b>';
        const desc   = p.desc ? `<br/>${p.desc}` : '';
        marker.bindPopup(`${titulo}${desc}`);

        bounds.push(coord);
        if (p.name) {
          markersByName[p.name] = marker;
        }
      }
    });

    if (bounds.length > 1) {
      map.fitBounds(bounds, { padding: [20, 20] });
    }
  }

  // link lista da direita ↔ markers
  const itensLista = document.querySelectorAll('[data-ponto]');
  itensLista.forEach(li => {
    const nome = li.dataset.ponto;
    const marker = markersByName[nome];

    if (marker) {
      li.classList.add('has-marker');
      li.addEventListener('click', () => {
        itensLista.forEach(el => el.classList.remove('is-active'));
        li.classList.add('is-active');

        const latLng = marker.getLatLng();
        map.setView(latLng, 18, { animate: true });
        marker.openPopup();
      });
    }
  });

  // clique no mapa abre Google Maps
  map.on('click', (ev) => {
    const { lat, lng } = ev.latlng;
    const gmaps = `https://www.google.com/maps?q=${lat},${lng}&z=${map.getZoom()}`;
    window.open(gmaps, '_blank', 'noopener,noreferrer');
  });

  setTimeout(() => map.invalidateSize(), 0);
  window.addEventListener('resize', () => map.invalidateSize());
})();
</script>
{% endblock %}


