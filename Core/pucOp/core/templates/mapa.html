{% extends "base.html" %}
{% load static %}

{% block title %}PUC Oportunidades — Mapa{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/mapa.css' %}">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="{% static 'css/mapa-leaflet.css' %}">
{% endblock %}

{% block content %}
<div class="site-root">
  <section class="hero">
    <div class="map-container">
      <div class="hero-card">
        <div class="hero-card__ornament" aria-hidden="true"></div>
        <div class="hero-card__sealwrap">
          <img class="hero-card__seal" src="{{ hero.logo_url }}" alt="Brasão da PUC-Rio" />
        </div>
        <div class="hero-card__text">
          <h2 class="hero-card__title">{{ hero.titulo }}</h2>
          <p class="hero-card__desc">{{ hero.descricao }}</p>
        </div>
      </div>
    </div>
  </section>

  <main class="conteudo-principal">
    <div class="map-container">
      <div class="colunas">
        <section class="coluna-esquerda">
          <div class="cartao cartao--espacado">
            <h2 class="titulo-cartao">Mapa PUC-Rio</h2>
          </div>
          <div class="cartao cartao--crescer cartao--mapa">
            <div id="map" class="mapa-interativo" aria-label="Mapa PUC-Rio"></div>
            <noscript>
              <a href="{{ mapa.link }}" target="_blank" rel="noopener noreferrer" title="Abrir no Google Maps">Ver no Google Maps</a>
            </noscript>
          </div>
        </section>

        <aside class="coluna-direita">
          {% for p in paines %}
          <div class="cartao">
            <div class="cabecalho-cartao">
              <span class="indicador indicador--{{ p.color }}" aria-hidden="true"></span>
              <h3 class="titulo-cartao">{{ p.title }}</h3>
            </div>
            <ul class="lista-informacoes">
              {% for item in p.itens %}
                <li><span class="indice">{{ forloop.counter }}.</span> {{ item }}</li>
              {% endfor %}
            </ul>
          </div>
          {% endfor %}
        </aside>
      </div>
    </div>
  </main>
</div>
{% if pontos %}{{ pontos|json_script:"pontos-data" }}{% endif %}
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  const INITIAL_COORDS = [-22.9796, -43.2335];
  const INITIAL_ZOOM = 16;
  const map = L.map('map', { zoomControl: true, scrollWheelZoom: true, dragging: true, tap: true }).setView(INITIAL_COORDS, INITIAL_ZOOM);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap colaboradores' }).addTo(map);
  L.marker(INITIAL_COORDS).addTo(map).bindPopup('<b>PUC-Rio</b><br/>Campus Gávea');
  try {
    const el = document.getElementById('pontos-data');
    if (el) {
      const pontos = JSON.parse(el.textContent);
      if (Array.isArray(pontos)) {
        const bounds = [];
        pontos.forEach(p => {
          if (typeof p.lat === 'number' && typeof p.lng === 'number') {
            const m = L.marker([p.lat, p.lng]).addTo(map);
            const titulo = p.name ? `<b>${p.name}</b>` : '<b>Ponto</b>';
            const desc = p.desc ? `<br/>${p.desc}` : '';
            m.bindPopup(`${titulo}${desc}`);
            bounds.push([p.lat, p.lng]);
          }
        });
        if (bounds.length) map.fitBounds(bounds, { padding: [20, 20] });
      }
    }
  } catch (e) {}
  map.on('click', (ev) => {
    const { lat, lng } = ev.latlng;
    const gmaps = `https://www.google.com/maps?q=${lat},${lng}&z=${map.getZoom()}`;
    window.open(gmaps, '_blank', 'noopener,noreferrer');
  });
  setTimeout(() => map.invalidateSize(), 0);
  window.addEventListener('resize', () => map.invalidateSize());
</script>
{% endblock %}
